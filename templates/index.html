<!DOCTYPE html>
<html>
<head>
    <title>My Calendars</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script>
        (function() {
            const theme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', theme);
        })();
    </script>
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        :root { --bg: #f0f2f5; --card: #ffffff; --border: #e4e7ec; --text: #1a1d23; --muted: #6b7280; --accent: #3b82f6; --green: #22c55e; --yellow: #eab308; --red: #ef4444; --shadow: 0 1px 3px rgba(0,0,0,0.08), 0 4px 16px rgba(0,0,0,0.06); --shadow-hover: 0 4px 12px rgba(0,0,0,0.10), 0 8px 28px rgba(0,0,0,0.08); }
        [data-theme="dark"] { --bg: #0f1117; --card: #1a1d23; --border: #2d3038; --text: #f1f5f9; --muted: #94a3b8; --shadow: 0 1px 3px rgba(0,0,0,0.3), 0 4px 16px rgba(0,0,0,0.2); --shadow-hover: 0 4px 12px rgba(0,0,0,0.4), 0 8px 28px rgba(0,0,0,0.3); }
        body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; padding: 40px 20px 60px; transition: background 0.3s, color 0.3s; font-size: 15px; }
        .topbar { max-width: 900px; margin: 0 auto 40px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; }
        .topbar-left h1 { font-size: 26px; font-weight: 700; letter-spacing: -0.5px; }
        .topbar-left p { font-size: 14px; color: var(--muted); margin-top: 3px; }
        .topbar-right { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
        .icon-btn { display: flex; align-items: center; gap: 6px; padding: 8px 14px; background: var(--card); border: 1px solid var(--border); border-radius: 8px; color: var(--muted); text-decoration: none; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; font-family: 'DM Sans', sans-serif; }
        .icon-btn:hover { color: var(--text); border-color: var(--text); }
        .create-section { max-width: 900px; margin: 0 auto 30px; }
        .create-form { display: flex; gap: 10px; background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 12px; box-shadow: var(--shadow); }
        .create-form input { flex: 1; padding: 10px 14px; border: 1px solid var(--border); border-radius: 8px; font-size: 15px; font-family: 'DM Sans', sans-serif; color: var(--text); background: var(--bg); outline: none; transition: border-color 0.2s; }
        .create-form input:focus { border-color: var(--accent); }
        .create-form input::placeholder { color: var(--muted); }
        .create-form button { padding: 10px 22px; background: var(--accent); color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; font-family: 'DM Sans', sans-serif; cursor: pointer; transition: background 0.2s; }
        .create-form button:hover { background: #2563eb; }
        .calendars-grid { max-width: 900px; margin: 0 auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; }
        .calendar-card { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 20px; position: relative; box-shadow: var(--shadow); transition: box-shadow 0.2s, transform 0.2s; overflow: hidden; }
        .calendar-card:hover { box-shadow: var(--shadow-hover); transform: translateY(-2px); }
        .calendar-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, var(--accent), #6366f1); border-radius: 14px 14px 0 0; }
        .card-link { position: absolute; inset: 0; z-index: 1; border-radius: 14px; }
        .card-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 14px; }
        .card-left { display: flex; align-items: center; gap: 10px; flex: 1; min-width: 0; }
        .card-icon { width: 34px; height: 34px; background: #eff6ff; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0; position: relative; z-index: 2; }
        [data-theme="dark"] .card-icon { background: #1e3a5f; }
        .card-title-wrap { flex: 1; min-width: 0; position: relative; z-index: 2; }
        .card-title { font-size: 16px; font-weight: 700; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: text; padding: 2px 4px; border-radius: 4px; transition: background 0.2s; position: relative; z-index: 2; }
        .card-title:hover { background: var(--bg); }
        .rename-hint { font-size: 11px; color: var(--muted); margin-top: 2px; }
        .rename-input { font-size: 16px; font-weight: 700; font-family: 'DM Sans', sans-serif; color: var(--text); background: var(--bg); border: 1px solid var(--accent); border-radius: 6px; padding: 2px 8px; outline: none; width: 100%; }
        .delete-btn { position: relative; z-index: 2; display: flex; flex-direction: column; align-items: center; gap: 2px; padding: 6px 8px; border-radius: 8px; text-decoration: none; color: var(--muted); transition: all 0.2s; flex-shrink: 0; }
        .delete-btn:hover { background: #fee2e2; color: var(--red); }
        .delete-btn .del-icon { font-size: 16px; }
        .delete-btn .del-label { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; }
        .progress-section { margin-bottom: 14px; }
        .progress-label { display: flex; justify-content: space-between; font-size: 12px; color: var(--muted); margin-bottom: 6px; font-weight: 500; }
        .progress-bar { height: 6px; background: var(--border); border-radius: 99px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--green), #16a34a); border-radius: 99px; transition: width 0.4s ease; }
        .pills-row { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 14px; }
        .pill { display: flex; align-items: center; gap: 5px; padding: 4px 10px; border-radius: 99px; font-size: 12px; font-weight: 600; }
        .pill-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
        .pill.overdue { background: #fee2e2; color: #b91c1c; }
        .pill.overdue .pill-dot { background: var(--red); }
        .pill.warning { background: #fef9c3; color: #854d0e; }
        .pill.warning .pill-dot { background: var(--yellow); }
        .pill.ontrack { background: #dcfce7; color: #15803d; }
        .pill.ontrack .pill-dot { background: var(--green); }
        [data-theme="dark"] .pill.overdue { background: #3b0f0f; color: #fca5a5; }
        [data-theme="dark"] .pill.warning { background: #3b2f0f; color: #fde68a; }
        [data-theme="dark"] .pill.ontrack { background: #0f3b1f; color: #86efac; }
        .card-footer { display: flex; gap: 16px; padding-top: 12px; border-top: 1px solid var(--border); }
        .stat-item { display: flex; flex-direction: column; gap: 2px; }
        .stat-number { font-size: 20px; font-weight: 700; font-family: 'DM Mono', monospace; line-height: 1; }
        .stat-label { font-size: 11px; color: var(--muted); font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-divider { width: 1px; background: var(--border); align-self: stretch; }
        .empty-state { max-width: 900px; margin: 0 auto; text-align: center; padding: 60px 20px; color: var(--muted); }
        .empty-state .empty-icon { font-size: 48px; margin-bottom: 12px; }
        .empty-state p { font-size: 16px; }
        .copyright { text-align: center; padding: 24px 0 8px; font-size: 12px; color: var(--muted); user-select: none; }
        .copyright a { color: var(--muted); text-decoration: none; font-weight: 600; transition: color 0.2s; }
        .copyright a:hover { color: var(--accent); }
        @media (max-width: 600px) {
            body { font-size: 16px; padding: 16px 12px 40px; }
            .topbar-left h1 { font-size: 20px; }
            .topbar-left p { font-size: 13px; }
            .icon-btn { font-size: 13px; padding: 7px 10px; }
            .create-form input, .create-form button { font-size: 16px; }
            .calendars-grid { grid-template-columns: 1fr; }
            .card-title { font-size: 17px; }
            .stat-number { font-size: 22px; }
            .stat-label { font-size: 12px; }
            input, select, button { font-size: 16px; }
        }
    </style>
</head>
<body>

    <div class="topbar">
        <div class="topbar-left">
            <h1>üìÖ <span data-i18n="my_calendars">My Calendars</span></h1>
            <p><span data-i18n="welcome_back">Welcome back</span>, {{ current_user.username }}</p>
        </div>
        <div class="topbar-right">
            <button class="icon-btn" id="lang-btn" onclick="toggleLang()">‰∏≠Êñá</button>
            <button class="icon-btn" id="dark-btn" onclick="toggleDark()">üåô</button>
            <a class="icon-btn" href="/settings">‚öôÔ∏è <span data-i18n="settings">Settings</span></a>
            <a class="icon-btn" href="/logout">‚Ü© <span data-i18n="logout">Log out</span></a>
        </div>
    </div>

    <div class="create-section">
        <form class="create-form" action="/calendar/create" method="POST">
            <input type="text" name="name" id="create-input" data-i18n-placeholder="new_cal_ph" placeholder="New calendar name..." required>
            <button type="submit" id="create-btn" data-i18n="create">+ Create</button>
        </form>
    </div>

    {% if calendars|length > 0 %}
    <div class="calendars-grid">
        {% for cal in calendars %}
        {% set stats = calendar_stats[cal['id']] %}
        {% set pct = ((stats['done'] / stats['total']) * 100) | int if stats['total'] > 0 else 0 %}
        <div class="calendar-card">
            <a class="card-link" href="/calendar/{{ cal['id'] }}"></a>
            <div class="card-top">
                <div class="card-left">
                    <div class="card-icon">üìÖ</div>
                    <div class="card-title-wrap">
                        <div class="card-title" id="cal-name-{{ cal['id'] }}" title="Click to rename"
                             onclick="startRename({{ cal['id'] }}, this, event)">{{ cal['name'] }}</div>
                        <div class="rename-hint" data-i18n="click_rename">Click name to rename</div>
                    </div>
                </div>
                <a class="delete-btn" href="/calendar/delete/{{ cal['id'] }}"
                   onclick="return confirm(t('delete_confirm').replace('{name}', '{{ cal['name'] }}'))">
                    <span class="del-icon">üóëÔ∏è</span>
                    <span class="del-label" data-i18n="delete">Delete</span>
                </a>
            </div>

            <div class="progress-section">
                <div class="progress-label">
                    <span data-i18n="progress">Progress</span>
                    <span>{{ pct }}% <span data-i18n="complete">complete</span></span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: {{ pct }}%"></div>
                </div>
            </div>

            <div class="pills-row">
                {% if stats['overdue'] > 0 %}
                    <span class="pill overdue"><span class="pill-dot"></span>{{ stats['overdue'] }} <span data-i18n="overdue">overdue</span></span>
                {% endif %}
                {% if stats['warning'] > 0 %}
                    <span class="pill warning"><span class="pill-dot"></span>{{ stats['warning'] }} <span data-i18n="due_soon">due soon</span></span>
                {% endif %}
                {% if stats['ontrack'] > 0 %}
                    <span class="pill ontrack"><span class="pill-dot"></span>{{ stats['ontrack'] }} <span data-i18n="on_track">on track</span></span>
                {% endif %}
                {% if stats['total'] == 0 %}
                    <span style="font-size:13px;color:var(--muted);" data-i18n="no_tasks_yet">No tasks yet</span>
                {% endif %}
            </div>

            <div class="card-footer">
                <div class="stat-item">
                    <span class="stat-number">{{ stats['total'] }}</span>
                    <span class="stat-label" data-i18n="total">Total</span>
                </div>
                <div class="stat-divider"></div>
                <div class="stat-item">
                    <span class="stat-number" style="color:var(--green);">{{ stats['done'] }}</span>
                    <span class="stat-label" data-i18n="done">Done</span>
                </div>
                <div class="stat-divider"></div>
                <div class="stat-item">
                    <span class="stat-number" style="color:var(--accent);">{{ stats['due'] }}</span>
                    <span class="stat-label" data-i18n="left">Left</span>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-icon">üì≠</div>
        <p data-i18n="no_calendars">No calendars yet. Create your first one above!</p>
    </div>
    {% endif %}

    <div class="copyright">¬© 2026 <a href="#" title="Developer">Alireza Nomani</a>. All rights reserved.</div>

    <script>
        const LANG = {
            en: { my_calendars:'My Calendars', welcome_back:'Welcome back', settings:'Settings', logout:'Log out', new_cal_ph:'New calendar name (e.g. Work, Personal, Travel...)', create:'+ Create', click_rename:'Click name to rename', delete:'Delete', delete_confirm:'Delete {name} and all its tasks?', progress:'Progress', complete:'complete', overdue:'overdue', due_soon:'due soon', on_track:'on track', no_tasks_yet:'No tasks yet', total:'Total', done:'Done', left:'Left', no_calendars:'No calendars yet. Create your first one above!' },
            zh: { my_calendars:'ÊàëÁöÑÊó•ÂéÜ', welcome_back:'Ê¨¢ËøéÂõûÊù•', settings:'ËÆæÁΩÆ', logout:'ÈÄÄÂá∫ÁôªÂΩï', new_cal_ph:'Êñ∞Êó•ÂéÜÂêçÁß∞ÔºàÂ¶ÇÂ∑•‰Ωú„ÄÅ‰∏™‰∫∫„ÄÅÊóÖË°å...Ôºâ', create:'+ ÂàõÂª∫', click_rename:'ÁÇπÂáªÂêçÁß∞ÈáçÂëΩÂêç', delete:'Âà†Èô§', delete_confirm:'Á°ÆËÆ§Âà†Èô§"{name}"ÂèäÂÖ∂ÊâÄÊúâ‰ªªÂä°Ôºü', progress:'ËøõÂ∫¶', complete:'Â∑≤ÂÆåÊàê', overdue:'Â∑≤ÈÄæÊúü', due_soon:'Âç≥Â∞ÜÂà∞Êúü', on_track:'ËøõË°å‰∏≠', no_tasks_yet:'ÊöÇÊó†‰ªªÂä°', total:'ÊÄªËÆ°', done:'ÂÆåÊàê', left:'Ââ©‰Ωô', no_calendars:'ÊöÇÊó†Êó•ÂéÜÔºåËØ∑Âú®‰∏äÊñπÂàõÂª∫Á¨¨‰∏Ä‰∏™ÔºÅ' }
        };
        let currentLang = localStorage.getItem('lang') || 'en';
        function t(key) { return LANG[currentLang][key] || key; }
        function applyLang() {
            document.querySelectorAll('[data-i18n]').forEach(el => { const k=el.dataset.i18n; if(LANG[currentLang][k]) el.textContent=LANG[currentLang][k]; });
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => { const k=el.dataset.i18nPlaceholder; if(LANG[currentLang][k]) el.placeholder=LANG[currentLang][k]; });
        }
        function toggleLang() { currentLang=currentLang==='en'?'zh':'en'; localStorage.setItem('lang',currentLang); applyLang(); updateLangBtn(); }
        function updateLangBtn() { document.getElementById('lang-btn').textContent=currentLang==='en'?'‰∏≠Êñá':'EN'; }
        function toggleDark() { const n=document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark'; document.documentElement.setAttribute('data-theme',n); localStorage.setItem('theme',n); document.getElementById('dark-btn').textContent=n==='dark'?'‚òÄÔ∏è':'üåô'; }
        function updateDarkBtn() { const isDark=document.documentElement.getAttribute('data-theme')==='dark'; document.getElementById('dark-btn').textContent=isDark?'‚òÄÔ∏è':'üåô'; }

        function startRename(calId, el, event) {
            event.stopPropagation(); event.preventDefault();
            const currentName = el.textContent.trim();
            const input = document.createElement('input');
            input.type='text'; input.value=currentName; input.className='rename-input';
            input.onclick=e=>{e.stopPropagation();e.preventDefault();};
            input.onblur=()=>saveRename(calId, input, currentName);
            input.onkeydown=e=>{ if(e.key==='Enter') input.blur(); if(e.key==='Escape'){el.textContent=currentName; el.onclick=(ev)=>startRename(calId,el,ev);}};
            el.textContent=''; el.onclick=null; el.appendChild(input);
            input.focus(); input.select();
        }

        async function saveRename(calId, input, fallback) {
            const name=input.value.trim();
            const el=document.getElementById(`cal-name-${calId}`);
            if(!name){el.textContent=fallback;el.onclick=(ev)=>startRename(calId,el,ev);return;}
            try {
                const res=await fetch(`/api/calendar/rename/${calId}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name})});
                const data=await res.json();
                el.textContent=data.success?data.name:fallback;
            } catch { el.textContent=fallback; }
            el.onclick=(ev)=>startRename(calId,el,ev);
        }

        updateDarkBtn(); applyLang(); updateLangBtn();
    </script>
</body>
</html>