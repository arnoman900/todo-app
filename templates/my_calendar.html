<!DOCTYPE html>
<html>
<head>
    <title>{{ calendar['name'] }}</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script>(function(){const t=localStorage.getItem('theme')||'light';document.documentElement.setAttribute('data-theme',t);})();</script>
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        :root { --bg: #f0f2f5; --card: #ffffff; --border: #e4e7ec; --text: #1a1d23; --muted: #6b7280; --accent: #3b82f6; --green: #22c55e; --yellow: #eab308; --red: #ef4444; --shadow: 0 1px 3px rgba(0,0,0,0.08), 0 4px 16px rgba(0,0,0,0.06); }
        [data-theme="dark"] { --bg: #0f1117; --card: #1a1d23; --border: #2d3038; --text: #f1f5f9; --muted: #94a3b8; }
        body { font-family: 'DM Sans', sans-serif; max-width: 1000px; margin: 0 auto; background: var(--bg); color: var(--text); padding: 30px 20px 60px; transition: background 0.3s, color 0.3s; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .header-left { display: flex; align-items: center; gap: 12px; }
        h1 { font-size: 22px; font-weight: 700; }
        .header-right { display: flex; gap: 8px; }
        .icon-btn { display: flex; align-items: center; gap: 5px; padding: 7px 13px; background: var(--card); border: 1px solid var(--border); border-radius: 8px; color: var(--muted); text-decoration: none; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s; font-family: 'DM Sans', sans-serif; }
        .icon-btn:hover { color: var(--text); border-color: var(--text); }
        .view-switcher { display: flex; gap: 4px; margin-bottom: 18px; background: var(--card); padding: 5px; border-radius: 10px; border: 1px solid var(--border); width: fit-content; }
        .view-btn { padding: 6px 18px; border: none; border-radius: 7px; cursor: pointer; font-size: 13px; font-weight: 600; font-family: 'DM Sans', sans-serif; background: transparent; color: var(--muted); transition: all 0.2s; }
        .view-btn.active { background: var(--accent); color: white; }
        .view-btn:hover:not(.active) { background: var(--bg); color: var(--text); }
        .nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; gap: 8px; }
        .nav button { padding: 7px 14px; border: 1px solid var(--border); border-radius: 8px; background: var(--card); color: var(--text); cursor: pointer; font-size: 13px; font-weight: 600; font-family: 'DM Sans', sans-serif; transition: all 0.2s; }
        .nav button:hover { background: var(--accent); color: white; border-color: var(--accent); }
        .nav .today-btn { background: var(--bg); color: var(--accent); border-color: var(--accent); font-size: 12px; padding: 6px 12px; }
        .nav .today-btn:hover { background: var(--accent); color: white; }
        .nav-title { font-size: 17px; font-weight: 700; flex: 1; text-align: center; }

        /* ===== DAY VIEW ===== */
        .day-view { background: var(--card); border-radius: 12px; border: 1px solid var(--border); overflow: hidden; display: flex; flex-direction: column; }
        .day-allday { display: flex; align-items: flex-start; gap: 0; border-bottom: 2px solid var(--border); min-height: 48px; cursor: pointer; transition: background 0.15s; }
        .day-allday:hover { background: var(--bg); }
        .day-allday-label { font-size: 10px; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; padding: 12px 8px 12px 0; min-width: 60px; text-align: right; flex-shrink: 0; }
        .day-allday-divider { width: 1px; background: var(--border); align-self: stretch; flex-shrink: 0; }
        .day-allday-tasks { flex: 1; padding: 8px 10px; display: flex; flex-wrap: wrap; gap: 4px; min-height: 38px; align-items: flex-start; }
        .day-scroll { overflow-y: auto; max-height: calc(100vh - 320px); min-height: 500px; }
        .day-time-grid { position: relative; height: 1440px; margin-left: 60px; margin-right: 8px; cursor: crosshair; }
        .day-hour-label-abs { position: absolute; left: -58px; width: 52px; text-align: right; font-size: 11px; color: var(--muted); font-weight: 600; font-family: 'DM Mono', monospace; padding-right: 8px; user-select: none; pointer-events: none; line-height: 1; }
        .day-hour-line { position: absolute; left: -2px; right: 0; border-top: 1px solid var(--border); }
        .day-half-line-abs { position: absolute; left: 0; right: 0; border-top: 1px dashed var(--border); opacity: 0.35; pointer-events: none; }
        .day-hover-band { position: absolute; left: 0; right: 0; height: 30px; background: transparent; transition: background 0.1s; pointer-events: none; }
        .day-task-block { position: absolute; border-radius: 7px; padding: 4px 8px; font-size: 12px; font-weight: 600; color: white; cursor: pointer; overflow: hidden; z-index: 2; transition: filter 0.15s, box-shadow 0.15s; box-shadow: 0 1px 4px rgba(0,0,0,0.18); }
        .day-task-block:hover { filter: brightness(1.1); box-shadow: 0 3px 10px rgba(0,0,0,0.25); z-index: 3; }
        .day-task-block.overdue  { background: var(--red); }
        .day-task-block.warning  { background: var(--yellow); color: #1a1d23; }
        .day-task-block.ontrack  { background: var(--green); }
        .day-task-block.done     { background: #9ca3af; }
        .day-task-block.done .day-task-title { text-decoration: line-through; opacity: 0.8; }
        .day-task-time-range { font-size: 10px; opacity: 0.88; font-family: 'DM Mono', monospace; margin-bottom: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .day-task-title { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 12px; }
        .day-task-inline { display: flex; align-items: center; gap: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .day-task-time-sm { font-size: 10px; opacity: 0.88; font-family: 'DM Mono', monospace; flex-shrink: 0; }
        .current-time-line { position: absolute; left: 0; right: 0; height: 2px; background: var(--red); z-index: 10; pointer-events: none; }
        .current-time-dot { position: absolute; left: -5px; top: -4px; width: 10px; height: 10px; border-radius: 50%; background: var(--red); }
        .day-time-grid.drag-active { cursor: grabbing; }

        /* ===== WEEK VIEW ===== */
        .week-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .week-day { background: var(--card); border-radius: 10px; padding: 10px; min-height: 130px; cursor: pointer; border: 1px solid var(--border); transition: box-shadow 0.2s, transform 0.2s; }
        .week-day:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); transform: translateY(-1px); }
        .week-day.today { border: 2px solid var(--accent); }
        .week-day.drag-over { background: #eff6ff !important; border: 2px dashed var(--accent) !important; }
        [data-theme="dark"] .week-day.drag-over { background: #1e3a5f !important; }
        .week-day-header { font-size: 10px; color: var(--muted); font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px; }
        .week-day-number { font-size: 19px; font-weight: 700; font-family: 'DM Mono', monospace; margin-bottom: 6px; }

        /* ===== MONTH VIEW ===== */
        .month-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 3px; }
        .month-day-name { text-align: center; font-size: 11px; font-weight: 700; color: var(--muted); padding: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
        .month-day { background: var(--card); border-radius: 7px; padding: 6px; min-height: 82px; cursor: pointer; border: 1px solid var(--border); transition: box-shadow 0.2s; }
        .month-day:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .month-day.other-month { background: var(--bg); opacity: 0.5; pointer-events: none; }
        .month-day.today { border: 2px solid var(--accent); }
        .month-day.drag-over { background: #eff6ff !important; border: 2px dashed var(--accent) !important; }
        [data-theme="dark"] .month-day.drag-over { background: #1e3a5f !important; }
        .month-day-number { font-size: 12px; font-weight: 700; margin-bottom: 3px; }

        /* ===== YEAR VIEW ===== */
        .year-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
        .year-month { background: var(--card); border-radius: 10px; padding: 11px; border: 1px solid var(--border); }
        .year-month-title { font-size: 12px; font-weight: 700; margin-bottom: 7px; text-align: center; }
        .year-month-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
        .year-day-name { font-size: 8px; color: var(--muted); text-align: center; font-weight: 700; }
        .year-day { font-size: 9.5px; text-align: center; padding: 2px; border-radius: 3px; cursor: pointer; color: var(--text); }
        .year-day:hover { background: #eff6ff; }
        [data-theme="dark"] .year-day:hover { background: #1e3a5f; }
        .year-day.today { background: var(--accent); color: white; border-radius: 50%; }

        /* ===== PILLS (week/month) ===== */
        .task-pill { font-size: 11px; padding: 2px 7px; border-radius: 99px; margin: 2px 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: white; display: block; font-weight: 500; cursor: grab; user-select: none; transition: opacity 0.2s; }
        .task-pill:active { cursor: grabbing; opacity: 0.7; }
        .task-pill.overdue { background: var(--red); }
        .task-pill.warning { background: var(--yellow); color: #1a1d23; }
        .task-pill.ontrack { background: var(--green); }
        .task-pill.done { background: #9ca3af; text-decoration: line-through; }
        .task-pill.recurring::after { content: ' üîÅ'; font-size: 9px; }
        .task-time { font-size: 9px; opacity: 0.85; margin-right: 3px; }
        .dot { width: 5px; height: 5px; border-radius: 50%; display: inline-block; margin: 1px; }
        .dot.overdue { background: var(--red); } .dot.warning { background: var(--yellow); }
        .dot.ontrack { background: var(--green); } .dot.done { background: #9ca3af; }
        .dots-row { display: flex; flex-wrap: wrap; justify-content: center; margin-top: 1px; }

        /* ===== MODAL ===== */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.45); z-index: 1000; justify-content: center; align-items: center; }
        .modal-overlay.open { display: flex; }
        .modal { background: var(--card); border-radius: 14px; padding: 24px; width: 460px; max-width: 95%; max-height: 88vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.25); border: 1px solid var(--border); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .modal-title { font-size: 16px; font-weight: 700; }
        .modal-close { background: var(--bg); border: none; width: 28px; height: 28px; border-radius: 50%; font-size: 13px; cursor: pointer; color: var(--muted); display: flex; align-items: center; justify-content: center; }
        .modal-close:hover { background: #fee2e2; color: var(--red); }
        .add-task-form { display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid var(--border); }
        .add-task-form input, .add-task-form select { padding: 9px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; font-family: 'DM Sans', sans-serif; color: var(--text); background: var(--bg); outline: none; transition: border-color 0.2s; }
        .add-task-form input:focus, .add-task-form select:focus { border-color: var(--accent); }
        .date-row { display: flex; gap: 8px; }
        .date-row input[type="date"] { flex: 1; }
        .time-range-row { display: flex; align-items: center; gap: 6px; }
        .time-range-row input[type="time"] { flex: 1; min-width: 0; }
        .time-range-sep { color: var(--muted); font-size: 13px; font-weight: 600; flex-shrink: 0; }
        .time-range-icon { font-size: 14px; flex-shrink: 0; }
        .add-task-form button { padding: 9px; background: var(--green); color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; font-family: 'DM Sans', sans-serif; cursor: pointer; transition: background 0.2s; }
        .add-task-form button:hover { background: #16a34a; }
        .modal-task { padding: 11px 13px; border-radius: 9px; margin-bottom: 8px; border-left: 4px solid var(--border); }
        .modal-task.overdue { background: #fee2e2; border-left-color: var(--red); }
        .modal-task.warning { background: #fef9c3; border-left-color: var(--yellow); }
        .modal-task.ontrack { background: #dcfce7; border-left-color: var(--green); }
        .modal-task.done { background: var(--bg); border-left-color: #9ca3af; }
        [data-theme="dark"] .modal-task.overdue { background: #3b0f0f; }
        [data-theme="dark"] .modal-task.warning { background: #3b2f0f; }
        [data-theme="dark"] .modal-task.ontrack { background: #0f3b1f; }
        .modal-task-row { display: flex; justify-content: space-between; align-items: center; gap: 8px; }
        .modal-task-info { display: flex; flex-direction: column; gap: 3px; flex: 1; }
        .modal-task-name { font-size: 14px; font-weight: 600; color: var(--text); }
        .modal-task-name.done-text { text-decoration: line-through; color: var(--muted); }
        .modal-task-time { font-size: 12px; color: var(--accent); font-weight: 600; font-family: 'DM Mono', monospace; }
        .modal-task-recur { font-size: 11px; color: var(--muted); }
        .modal-task-actions { display: flex; gap: 5px; }
        .btn-small { padding: 4px 9px; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; font-family: 'DM Sans', sans-serif; color: white; transition: opacity 0.2s; }
        .btn-small:hover { opacity: 0.85; }
        .btn-toggle { background: var(--green); } .btn-toggle.undo { background: #9ca3af; }
        .btn-edit { background: var(--accent); } .btn-delete { background: var(--red); }
        .edit-form { display: none; flex-direction: column; gap: 6px; margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border); }
        .edit-form.open { display: flex; }
        .edit-form input, .edit-form select { padding: 7px 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 13px; font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); }
        .edit-time-row { display: flex; align-items: center; gap: 6px; }
        .edit-time-row input[type="time"] { flex: 1; min-width: 0; }
        .edit-time-sep { color: var(--muted); font-size: 12px; font-weight: 600; }
        .edit-form-btns { display: flex; gap: 6px; }
        .btn-save { background: var(--accent); } .btn-cancel { background: #9ca3af; }
        .modal-empty { color: var(--muted); text-align: center; padding: 20px 0; font-size: 14px; }

        /* ===== PRINT ===== */
        @media print {
            @page { size: A4 landscape; margin: 15mm 12mm; }
            body { background: white !important; margin: 0; padding: 0; }
            .header, .view-switcher, .nav, .modal-overlay, #calendar-container { display: none !important; }
            .print-view { display: block !important; }
            .print-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 16px; padding-bottom: 10px; border-bottom: 2px solid #1a1d23; }
            .print-title { font-size: 22px; font-weight: 700; color: #1a1d23; }
            .print-subtitle { font-size: 13px; color: #6b7280; }
            .print-month-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 3px; }
            .print-day-name { text-align: center; font-size: 10px; font-weight: 700; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; padding: 4px; background: #f3f4f6; border-radius: 4px; }
            .print-day { border: 1px solid #e4e7ec; border-radius: 5px; padding: 5px; min-height: 70px; background: white; }
            .print-day.other-month { background: #f9fafb; }
            .print-day.today-print { border: 2px solid #3b82f6; }
            .print-day-number { font-size: 11px; font-weight: 700; color: #1a1d23; margin-bottom: 3px; }
            .print-task { font-size: 9px; padding: 1px 5px; border-radius: 3px; margin: 1px 0; display: block; color: white; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
            .print-task.overdue { background: #ef4444; } .print-task.warning { background: #eab308; color: #1a1d23; }
            .print-task.ontrack { background: #22c55e; } .print-task.done { background: #9ca3af; text-decoration: line-through; }
            .print-day-sched { width: 100%; border-collapse: collapse; }
            .print-day-sched td { padding: 3px 4px; vertical-align: top; }
            .print-day-sched .sched-time { font-size: 9px; color: #6b7280; font-family: monospace; white-space: nowrap; width: 50px; border-top: 1px solid #e4e7ec; }
            .print-day-sched .sched-tasks { border-top: 1px solid #e4e7ec; }
            .print-year-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
            .print-year-month { border: 1px solid #e4e7ec; border-radius: 6px; padding: 8px; }
            .print-year-month-title { font-size: 11px; font-weight: 700; color: #1a1d23; margin-bottom: 6px; text-align: center; }
            .print-year-mini-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; }
            .print-year-day-name { font-size: 7px; color: #9ca3af; text-align: center; font-weight: 700; }
            .print-year-day { font-size: 7.5px; text-align: center; padding: 1px; color: #374151; }
            .print-year-day.has-tasks { font-weight: 700; } .print-year-day.today-print { background: #3b82f6; color: white; border-radius: 50%; }
            .print-year-dots { display: flex; flex-wrap: wrap; justify-content: center; gap: 1px; margin-top: 1px; }
            .print-year-dot { width: 4px; height: 4px; border-radius: 50%; display: inline-block; }
            .print-year-dot.overdue { background: #ef4444; } .print-year-dot.warning { background: #eab308; }
            .print-year-dot.ontrack { background: #22c55e; } .print-year-dot.done { background: #9ca3af; }
            .print-legend { display: flex; gap: 16px; margin-top: 12px; padding-top: 8px; border-top: 1px solid #e4e7ec; }
            .legend-item { display: flex; align-items: center; gap: 5px; font-size: 10px; color: #374151; font-weight: 500; }
            .legend-dot { width: 10px; height: 10px; border-radius: 2px; }
            .legend-dot.overdue { background: #ef4444; } .legend-dot.warning { background: #eab308; }
            .legend-dot.ontrack { background: #22c55e; } .legend-dot.done { background: #9ca3af; }
        }
        .print-view { display: none; }
        .copyright { 
            text-align: center; 
            padding: 24px 0 8px; 
            font-size: 12px; 
            color: var(--muted); 
            user-select: none;
        }
        .copyright a { 
            color: var(--muted); 
            text-decoration: none; 
            font-weight: 600;
            transition: color 0.2s;
        }
        .copyright a:hover { color: var(--accent); }
    </style>
</head>
    <div class="copyright">¬© 2026 <a href="#" title="Developer">Alireza Nomani</a>. All rights reserved.</div>
<body>

<div class="header">
    <div class="header-left">
        <a class="icon-btn" href="/">‚Üê <span data-i18n="back">Back</span></a>
        <h1>üìÖ {{ calendar['name'] }}</h1>
    </div>
    <div class="header-right">
        <button class="icon-btn" id="lang-btn" onclick="toggleLang()">‰∏≠Êñá</button>
        <button class="icon-btn" id="dark-btn" onclick="toggleDark()">üåô</button>
        <button class="icon-btn" onclick="triggerPrint()">üñ®Ô∏è <span data-i18n="print">Print</span></button>
    </div>
</div>

<div class="view-switcher">
    <button class="view-btn active" id="btn-day"   onclick="switchView('day')"   data-i18n="day">Day</button>
    <button class="view-btn"        id="btn-week"  onclick="switchView('week')"  data-i18n="week">Week</button>
    <button class="view-btn"        id="btn-month" onclick="switchView('month')" data-i18n="month">Month</button>
    <button class="view-btn"        id="btn-year"  onclick="switchView('year')"  data-i18n="year">Year</button>
</div>

<div class="nav">
    <button onclick="navigate(-1)">‚Üê <span data-i18n="prev">Prev</span></button>
    <span class="nav-title" id="nav-title"></span>
    <button class="today-btn" onclick="goToToday()" data-i18n="today_btn">Today</button>
    <button onclick="navigate(1)"><span data-i18n="next">Next</span> ‚Üí</button>
</div>

<div id="calendar-container"></div>
<div class="print-view" id="print-view"></div>

<!-- Modal -->
<div class="modal-overlay" id="modal-overlay" onclick="handleOverlayClick(event)">
    <div class="modal">
        <div class="modal-header">
            <span class="modal-title" id="modal-title"></span>
            <button class="modal-close" onclick="closeModal()">‚úï</button>
        </div>
        <div class="add-task-form">
            <input type="text" id="new-task-name" data-i18n-placeholder="add_task_ph">
            <div class="date-row">
                <input type="date" id="new-task-date" onchange="updateRecurrenceOptions(this.value,'new-task-recurrence')">
            </div>
            <div class="time-range-row">
                <span class="time-range-icon">‚è∞</span>
                <input type="time" id="new-task-time" onchange="autoFillEndTime('new-task-time','new-task-time-end')">
                <span class="time-range-sep">‚Üí</span>
                <input type="time" id="new-task-time-end" data-i18n-placeholder="end_optional">
            </div>
            <select id="new-task-recurrence"><option value="none" data-i18n="no_repeat">No repeat</option></select>
            <button onclick="addTask()" data-i18n="add_task">+ Add Task</button>
        </div>
        <div id="modal-body"></div>
    </div>
</div>

<script>
// ===================== i18n =====================
const LANG = {
    en: {
        back:'Back', print:'Print', day:'Day', week:'Week', month:'Month', year:'Year',
        prev:'Prev', next:'Next', today_btn:'Today',
        add_task_ph:'Add a new task...', end_optional:'End (optional)',
        no_repeat:'No repeat', daily:'üîÅ Daily', weekly_on:'üîÅ Weekly on',
        monthly_on:'üîÅ Monthly on the', monthly_nth:'üîÅ Monthly on the', monthly_last:'üîÅ Monthly on the last',
        add_task:'+ Add Task', save:'üíæ Save', cancel:'Cancel',
        no_tasks:'No tasks on this day. Add one above!',
        delete_task:'Delete this task?', all_day:'All Day',
        repeats_daily:'üîÅ Repeats daily', every:'üîÅ Every', repeats_monthly:'üîÅ Repeats monthly',
        overdue:'Overdue', due_soon:'Due Soon', on_track:'On Track', done:'Done',
        printed:'Printed', recurring_legend:'üîÅ Recurring',
        DAY_NAMES:['Sun','Mon','Tue','Wed','Thu','Fri','Sat'],
        DAY_FULL:['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'],
        MONTH_NAMES:['January','February','March','April','May','June','July','August','September','October','November','December'],
        ORD:['','1st','2nd','3rd','4th','5th']
    },
    zh: {
        back:'ËøîÂõû', print:'ÊâìÂç∞', day:'Êó•', week:'Âë®', month:'Êúà', year:'Âπ¥',
        prev:'‰∏ä‰∏Ä', next:'‰∏ã‰∏Ä', today_btn:'‰ªäÂ§©',
        add_task_ph:'Ê∑ªÂä†Êñ∞‰ªªÂä°...', end_optional:'ÁªìÊùüÔºàÂèØÈÄâÔºâ',
        no_repeat:'‰∏çÈáçÂ§ç', daily:'üîÅ ÊØèÂ§©', weekly_on:'üîÅ ÊØèÂë®',
        monthly_on:'üîÅ ÊØèÊúà', monthly_nth:'üîÅ ÊØèÊúàÁ¨¨', monthly_last:'üîÅ ÊØèÊúàÊúÄÂêé‰∏Ä‰∏™',
        add_task:'+ Ê∑ªÂä†‰ªªÂä°', save:'üíæ ‰øùÂ≠ò', cancel:'ÂèñÊ∂à',
        no_tasks:'‰ªäÂ§©Ê≤°Êúâ‰ªªÂä°ÔºåËØ∑Âú®‰∏äÊñπÊ∑ªÂä†ÔºÅ',
        delete_task:'Á°ÆËÆ§Âà†Èô§Ê≠§‰ªªÂä°Ôºü', all_day:'ÂÖ®Â§©',
        repeats_daily:'üîÅ ÊØèÂ§©ÈáçÂ§ç', every:'üîÅ ÊØè', repeats_monthly:'üîÅ ÊØèÊúàÈáçÂ§ç',
        overdue:'Â∑≤ÈÄæÊúü', due_soon:'Âç≥Â∞ÜÂà∞Êúü', on_track:'ËøõË°å‰∏≠', done:'Â∑≤ÂÆåÊàê',
        printed:'ÊâìÂç∞‰∫é', recurring_legend:'üîÅ ÈáçÂ§ç‰ªªÂä°',
        DAY_NAMES:['Êó•','‰∏Ä','‰∫å','‰∏â','Âõõ','‰∫î','ÂÖ≠'],
        DAY_FULL:['Âë®Êó•','Âë®‰∏Ä','Âë®‰∫å','Âë®‰∏â','Âë®Âõõ','Âë®‰∫î','Âë®ÂÖ≠'],
        MONTH_NAMES:['1Êúà','2Êúà','3Êúà','4Êúà','5Êúà','6Êúà','7Êúà','8Êúà','9Êúà','10Êúà','11Êúà','12Êúà'],
        ORD:['','Á¨¨‰∏Ä','Á¨¨‰∫å','Á¨¨‰∏â','Á¨¨Âõõ','Á¨¨‰∫î']
    }
};
let currentLang = localStorage.getItem('lang') || 'en';
function t(key){ return LANG[currentLang][key] || key; }
function applyLang(){
    document.querySelectorAll('[data-i18n]').forEach(el=>{
        const k=el.dataset.i18n; if(LANG[currentLang][k]) el.textContent=LANG[currentLang][k];
    });
    document.querySelectorAll('[data-i18n-placeholder]').forEach(el=>{
        const k=el.dataset.i18nPlaceholder; if(LANG[currentLang][k]) el.placeholder=LANG[currentLang][k];
    });
}
function toggleLang(){ currentLang=currentLang==='en'?'zh':'en'; localStorage.setItem('lang',currentLang); applyLang(); updateLangBtn(); render(); }
function updateLangBtn(){ document.getElementById('lang-btn').textContent=currentLang==='en'?'‰∏≠Êñá':'EN'; }
function toggleDark(){ const n=document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark'; document.documentElement.setAttribute('data-theme',n); localStorage.setItem('theme',n); document.getElementById('dark-btn').textContent=n==='dark'?'‚òÄÔ∏è':'üåô'; }
function updateDarkBtn(){ document.getElementById('dark-btn').textContent=document.documentElement.getAttribute('data-theme')==='dark'?'‚òÄÔ∏è':'üåô'; }

// ===================== Data =====================
const calendarId = {{ calendar['id'] }};
const calendarName = {{ calendar['name'] | tojson }};
const today = "{{ today }}";
const tomorrow = "{{ tomorrow }}";

let allTasks = [
{% for task in tasks %}
{
    id: {{ task['id'] }},
    task: {{ task['task'] | tojson }},
    due_date: "{{ task['due_date'] if task['due_date'] else '' }}",
    due_time: "{{ task['due_time'] if task['due_time'] else '' }}",
    due_time_end: "{{ task['due_time_end'] if task['due_time_end'] else '' }}",
    done: {{ 'true' if task['done'] else 'false' }},
    recurrence: "{{ task['recurrence'] if task['recurrence'] else 'none' }}",
    completed_dates: {{ completions.get(task['id'], []) | tojson }}
},
{% endfor %}
];

let currentView = 'day';
let currentDate = new Date();
let selectedDate = '';
let dragTaskId = null;
const ORD_EN = ['','1st','2nd','3rd','4th','5th'];
const PX_PER_MIN = 1;   // 60px per hour

// ===================== Time helpers =====================
function timeToMinutes(s){ if(!s) return 0; const [h,m]=s.split(':').map(Number); return h*60+m; }
function minutesToTime(m){ const h=Math.max(0,Math.min(23,Math.floor(m/60))); const min=Math.max(0,Math.min(59,m%60)); return `${String(h).padStart(2,'0')}:${String(min).padStart(2,'0')}`; }

function formatTime(s){
    if(!s) return '';
    const [h,m]=s.split(':'); const hr=parseInt(h); const ampm=hr>=12?'PM':'AM'; const h12=hr%12||12;
    return `${h12}:${m}${ampm}`;
}
function formatTimeChinese(s){
    if(!s) return '';
    const [h,m]=s.split(':'); const hr=parseInt(h);
    const p=hr<6?'ÂáåÊô®':hr<12?'‰∏äÂçà':hr<18?'‰∏ãÂçà':'Êôö‰∏ä'; const h12=hr%12||12;
    return `${p}${h12}:${m}`;
}
function displayTime(s){ if(!s) return ''; return currentLang==='zh'?formatTimeChinese(s):formatTime(s); }

function displayTimeRange(start, end){
    if(!start) return '';
    const s = displayTime(start);
    return end ? `${s} ‚Äì ${displayTime(end)}` : s;
}

function hourLabel(h){
    if(currentLang==='zh'){
        const p=h<6?'ÂáåÊô®':h<12?'‰∏äÂçà':h<18?'‰∏ãÂçà':'Êôö‰∏ä'; const h12=h%12||12;
        return h===0?'':` ${p}${h12}`;
    }
    if(h===0) return ''; if(h===12) return '12 PM';
    return h<12?`${h} AM`:`${h-12} PM`;
}

function autoFillEndTime(startId, endId){
    const sv=document.getElementById(startId).value;
    const el=document.getElementById(endId);
    if(sv && !el.value){
        el.value = minutesToTime(timeToMinutes(sv)+60);
    }
}

function sortTasksByTime(tasks){
    return [...tasks].sort((a,b)=>{
        if(!a.due_time&&!b.due_time) return 0;
        if(!a.due_time) return 1; if(!b.due_time) return -1;
        return a.due_time.localeCompare(b.due_time);
    });
}

// Layout overlapping timed tasks into columns
function layoutTasks(timedTasks){
    if(!timedTasks.length) return [];
    const sorted=[...timedTasks].sort((a,b)=>a.due_time.localeCompare(b.due_time));
    sorted.forEach(t=>{
        t._start=timeToMinutes(t.due_time);
        t._end=t.due_time_end?timeToMinutes(t.due_time_end):t._start+60;
        if(t._end<=t._start) t._end=t._start+60;
    });
    const colEnds=[];
    sorted.forEach(task=>{
        let col=-1;
        for(let c=0;c<colEnds.length;c++){ if(task._start>=colEnds[c]){col=c;break;} }
        if(col===-1){ col=colEnds.length; colEnds.push(0); }
        task._col=col; colEnds[col]=task._end;
    });
    const totalCols=colEnds.length;
    sorted.forEach(task=>{ task._numCols=totalCols; });
    return sorted;
}

// ===================== Recurrence =====================
function ordSuffix(n){
    if(currentLang==='zh') return t('ORD')[n]||n+'';
    if(n>=11&&n<=13) return n+'th';
    switch(n%10){case 1:return n+'st';case 2:return n+'nd';case 3:return n+'rd';default:return n+'th';}
}

function updateRecurrenceOptions(dateStr, selectId){
    const sel=document.getElementById(selectId); if(!sel||!dateStr) return;
    const saved=sel.value;
    const d=new Date(dateStr+'T00:00:00');
    const dow=d.getDay(), dayName=t('DAY_FULL')[dow];
    const dom=d.getDate(), occ=Math.ceil(dom/7);
    const dim=new Date(d.getFullYear(),d.getMonth()+1,0).getDate();
    const isLast=(dom+7)>dim;
    if(currentLang==='en'){
        sel.innerHTML=`<option value="none">${t('no_repeat')}</option>
        <option value="daily">${t('daily')}</option>
        <option value="weekly">${t('weekly_on')} ${dayName}</option>
        <option value="monthly">${t('monthly_on')} ${ordSuffix(dom)}</option>
        <option value="monthly_weekday_${occ}_${dow}">${t('monthly_nth')} ${ordSuffix(occ)} ${dayName}</option>
        ${isLast?`<option value="monthly_weekday_last_${dow}">${t('monthly_last')} ${dayName}</option>`:''}`;
    } else {
        sel.innerHTML=`<option value="none">${t('no_repeat')}</option>
        <option value="daily">${t('daily')}</option>
        <option value="weekly">${t('weekly_on')}${dayName}</option>
        <option value="monthly">${t('monthly_on')}${dom}Êó•</option>
        <option value="monthly_weekday_${occ}_${dow}">üîÅ ÊØèÊúà${t('ORD')[occ]}‰∏™${dayName}</option>
        ${isLast?`<option value="monthly_weekday_last_${dow}">üîÅ ÊØèÊúàÊúÄÂêé‰∏Ä‰∏™${dayName}</option>`:''}`;
    }
    if([...sel.options].some(o=>o.value===saved)) sel.value=saved;
}

// ===================== Task helpers =====================
function isCompletedOnDate(task,dateStr){ if(!task.recurrence||task.recurrence==='none') return task.done; return task.completed_dates&&task.completed_dates.includes(dateStr); }
function getTaskClass(task,dateStr){ const d=dateStr||task.due_date; if(isCompletedOnDate(task,d)) return 'done'; if(!d) return 'ontrack'; if(d<today) return 'overdue'; if(d<=tomorrow) return 'warning'; return 'ontrack'; }
function isRecurrenceOf(task,dateStr){
    if(!task.due_date||!task.recurrence||task.recurrence==='none') return false;
    if(dateStr<=task.due_date) return false;
    const start=new Date(task.due_date+'T00:00:00'), target=new Date(dateStr+'T00:00:00');
    if(task.recurrence==='daily') return true;
    if(task.recurrence==='weekly') return Math.round((target-start)/86400000)%7===0;
    if(task.recurrence==='monthly') return target.getDate()===start.getDate();
    if(task.recurrence.startsWith('monthly_weekday_')){
        const parts=task.recurrence.split('_'), occ=parts[2], dow=parseInt(parts[3]);
        if(target.getDay()!==dow) return false;
        const td=target.getDate(), dim=new Date(target.getFullYear(),target.getMonth()+1,0).getDate();
        if(occ==='last') return(td+7)>dim;
        return Math.ceil(td/7)===parseInt(occ);
    }
    return false;
}
function getTasksForDate(dateStr){ return sortTasksByTime(allTasks.filter(t=>t.due_date===dateStr||isRecurrenceOf(t,dateStr))); }
function recurLabel(r,due_date){
    if(!r||r==='none') return '';
    if(r==='daily') return t('repeats_daily');
    if(r==='weekly'){ if(due_date){const d=new Date(due_date+'T00:00:00');return `${t('every')} ${t('DAY_FULL')[d.getDay()]}`;} return t('repeats_daily'); }
    if(r==='monthly') return t('repeats_monthly');
    if(r.startsWith('monthly_weekday_')){
        const parts=r.split('_'), occ=parts[2], dow=parseInt(parts[3]), dayName=t('DAY_FULL')[dow];
        if(currentLang==='en') return occ==='last'?`üîÅ Last ${dayName} of month`:`üîÅ ${ORD_EN[parseInt(occ)]} ${dayName} of month`;
        return occ==='last'?`üîÅ ÊØèÊúàÊúÄÂêé‰∏Ä‰∏™${dayName}`:`üîÅ ÊØèÊúàÁ¨¨${parseInt(occ)}‰∏™${dayName}`;
    }
    return '';
}
function formatDate(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
function friendlyDate(dateStr){
    const [y,m,d]=dateStr.split('-');
    if(currentLang==='zh') return `${y}Âπ¥${parseInt(m)}Êúà${parseInt(d)}Êó•`;
    return new Date(y,m-1,d).toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
}

// ===================== Navigation =====================
function switchView(view){
    currentView=view;
    document.querySelectorAll('.view-btn').forEach(b=>b.classList.remove('active'));
    document.getElementById('btn-'+view).classList.add('active');
    render();
}
function navigate(dir){
    if(currentView==='day') currentDate.setDate(currentDate.getDate()+dir);
    else if(currentView==='week') currentDate.setDate(currentDate.getDate()+dir*7);
    else if(currentView==='month') currentDate.setMonth(currentDate.getMonth()+dir);
    else currentDate.setFullYear(currentDate.getFullYear()+dir);
    render();
}
function goToToday(){ currentDate=new Date(); render(); }
function jumpToDay(dateStr){ const [y,m,d]=dateStr.split('-').map(Number); currentDate=new Date(y,m-1,d); switchView('day'); }
function render(){ if(currentView==='day') renderDay(); else if(currentView==='week') renderWeek(); else if(currentView==='month') renderMonth(); else renderYear(); }

// ===================== Drag & Drop =====================
function onDragStart(e,taskId){ dragTaskId=taskId; e.dataTransfer.effectAllowed='move'; e.dataTransfer.setData('text/plain',taskId); }
function onDragOver(e,el){ e.preventDefault(); document.querySelectorAll('.drag-over').forEach(d=>d.classList.remove('drag-over')); el.classList.add('drag-over'); }
function onDragLeave(el){ el.classList.remove('drag-over'); }
async function onDrop(e,dateStr,el){ e.preventDefault(); el.classList.remove('drag-over'); if(!dragTaskId) return; const taskId=dragTaskId; dragTaskId=null; const task=allTasks.find(t=>t.id===taskId); if(!task) return; await fetch(`/api/task/edit/${taskId}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({task:task.task,due_date:dateStr,due_time:task.due_time,due_time_end:task.due_time_end,recurrence:task.recurrence})}); task.due_date=dateStr; render(); }

// Drop onto day grid ‚Äî snaps time, preserves duration
async function onDayGridDrop(e,dateStr){
    e.preventDefault();
    const grid=document.getElementById('day-time-grid');
    if(grid) grid.classList.remove('drag-active');
    if(!dragTaskId) return;
    const taskId=dragTaskId; dragTaskId=null;
    const task=allTasks.find(t=>t.id===taskId); if(!task) return;
    const gridEl=document.getElementById('day-time-grid');
    const rect=gridEl.getBoundingClientRect();
    const y=e.clientY-rect.top;
    const snappedMins=Math.round(Math.max(0,Math.min(1439,y))/15)*15;
    const newTime=minutesToTime(snappedMins);
    let newEnd=task.due_time_end;
    if(task.due_time && task.due_time_end){
        const dur=timeToMinutes(task.due_time_end)-timeToMinutes(task.due_time);
        newEnd=minutesToTime(Math.min(1439,snappedMins+dur));
    }
    await fetch(`/api/task/edit/${taskId}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({task:task.task,due_date:dateStr,due_time:newTime,due_time_end:newEnd||'',recurrence:task.recurrence})});
    task.due_date=dateStr; task.due_time=newTime; task.due_time_end=newEnd||'';
    render();
}

// ===================== DAY VIEW =====================
function renderDay(){
    const dateStr=formatDate(currentDate);
    const DN=t('DAY_FULL'), MN=t('MONTH_NAMES');
    if(currentLang==='zh') document.getElementById('nav-title').textContent=`${currentDate.getFullYear()}Âπ¥${currentDate.getMonth()+1}Êúà${currentDate.getDate()}Êó• ${DN[currentDate.getDay()]}`;
    else document.getElementById('nav-title').textContent=currentDate.toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});

    const dayTasks=getTasksForDate(dateStr);
    const alldayTasks=dayTasks.filter(t=>!t.due_time);
    const timedTasks=dayTasks.filter(t=>t.due_time);
    const laidOut=layoutTasks(timedTasks);
    const isToday=dateStr===today;
    const now=new Date();

    // All-day band
    let html=`<div class="day-view">
    <div class="day-allday" onclick="openModal('${dateStr}')"
        ondragover="onDragOver(event,this)" ondragleave="onDragLeave(this)" ondrop="onDrop(event,'${dateStr}',this)">
        <div class="day-allday-label">${t('all_day')}</div>
        <div class="day-allday-divider"></div>
        <div class="day-allday-tasks">
            ${alldayTasks.length?alldayTasks.map(task=>pillHtml(task,dateStr)).join(''):`<span style="font-size:12px;color:var(--muted);padding-top:4px;">+ ${t('add_task_ph')}</span>`}
        </div>
    </div>`;

    // Scrollable time grid
    html+=`<div class="day-scroll" id="day-scroll">
    <div class="day-time-grid" id="day-time-grid"
        onclick="onDayGridClick(event,'${dateStr}')"
        ondragover="event.preventDefault();document.getElementById('day-time-grid').classList.add('drag-active')"
        ondragleave="document.getElementById('day-time-grid').classList.remove('drag-active')"
        ondrop="onDayGridDrop(event,'${dateStr}')">`;

    // Hour lines and labels
    for(let h=0;h<24;h++){
        const topPx=h*60;
        html+=`<div class="day-hour-label-abs" style="top:${topPx}px">${hourLabel(h)}</div>`;
        html+=`<div class="day-hour-line" style="top:${topPx}px"></div>`;
        if(h<23) html+=`<div class="day-half-line-abs" style="top:${topPx+30}px"></div>`;
    }

    // Task blocks (absolute positioned)
    laidOut.forEach(task=>{
        const cls=getTaskClass(task,dateStr);
        const top=task._start*PX_PER_MIN;
        const height=Math.max((task._end-task._start)*PX_PER_MIN, 28);
        const leftPct=task._col/task._numCols*100;
        const widthPct=100/task._numCols;
        const timeRange=displayTimeRange(task.due_time,task.due_time_end);
        const isShort=height<44;
        const recurIcon=task.recurrence!=='none'?' üîÅ':'';

        html+=`<div class="day-task-block ${cls}"
            draggable="true"
            ondragstart="onDragStart(event,${task.id})"
            onclick="event.stopPropagation();openModalWithTime('${dateStr}','${task.due_time}','${task.due_time_end||''}')"
            style="top:${top}px;height:${height}px;left:calc(${leftPct}%+2px);width:calc(${widthPct}%-4px);">
            ${isShort
                ?`<div class="day-task-inline"><span class="day-task-time-sm">${timeRange}</span><span>${task.task}${recurIcon}</span></div>`
                :`<div class="day-task-time-range">${timeRange}</div><div class="day-task-title">${task.task}${recurIcon}</div>`
            }
        </div>`;
    });

    // Current time line
    if(isToday){
        const nowMins=now.getHours()*60+now.getMinutes();
        html+=`<div class="current-time-line" style="top:${nowMins}px"><div class="current-time-dot"></div></div>`;
    }

    html+=`</div></div></div>`;
    document.getElementById('calendar-container').innerHTML=html;

    // Scroll to current time or 8am
    const scrollTo=isToday?Math.max(0,now.getHours()*60-60):8*60;
    setTimeout(()=>{ const s=document.getElementById('day-scroll'); if(s) s.scrollTop=scrollTo; },50);
}

function onDayGridClick(e,dateStr){
    if(e.target.closest('.day-task-block')) return;
    const gridEl=document.getElementById('day-time-grid');
    const rect=gridEl.getBoundingClientRect();
    const y=e.clientY-rect.top;
    const snappedMins=Math.round(Math.max(0,Math.min(1439,y))/15)*15;
    const startTime=minutesToTime(snappedMins);
    const endTime=minutesToTime(Math.min(1439,snappedMins+60));
    openModalWithTime(dateStr,startTime,endTime);
}

// ===================== WEEK VIEW =====================
function renderWeek(){
    const start=new Date(currentDate); start.setDate(start.getDate()-start.getDay());
    const end=new Date(start); end.setDate(end.getDate()+6);
    const DN=t('DAY_NAMES'), MN=t('MONTH_NAMES');
    document.getElementById('nav-title').textContent=`${MN[start.getMonth()]} ${start.getDate()} ‚Äì ${MN[end.getMonth()]} ${end.getDate()}, ${end.getFullYear()}`;
    let html='<div class="week-grid">';
    for(let i=0;i<7;i++){
        const d=new Date(start); d.setDate(d.getDate()+i); const dateStr=formatDate(d);
        const dayTasks=getTasksForDate(dateStr);
        html+=`<div class="week-day ${dateStr===today?'today':''}" onclick="openModal('${dateStr}')"
            ondragover="onDragOver(event,this)" ondragleave="onDragLeave(this)" ondrop="onDrop(event,'${dateStr}',this)">
            <div class="week-day-header">${DN[d.getDay()]}</div>
            <div class="week-day-number" onclick="event.stopPropagation();jumpToDay('${dateStr}')"
                style="cursor:pointer;text-decoration:underline dotted;text-underline-offset:3px;">${d.getDate()}</div>
            ${dayTasks.map(t=>pillHtml(t,dateStr)).join('')}
        </div>`;
    }
    html+='</div>';
    document.getElementById('calendar-container').innerHTML=html;
}

// ===================== MONTH VIEW =====================
function renderMonth(){
    const year=currentDate.getFullYear(), month=currentDate.getMonth();
    const DN=t('DAY_NAMES'), MN=t('MONTH_NAMES');
    document.getElementById('nav-title').textContent=`${MN[month]} ${year}`;
    const firstDay=new Date(year,month,1).getDay();
    const daysInMonth=new Date(year,month+1,0).getDate();
    const daysInPrev=new Date(year,month,0).getDate();
    let html='<div class="month-grid">';
    DN.forEach(d=>{html+=`<div class="month-day-name">${d}</div>`;});
    for(let i=firstDay-1;i>=0;i--) html+=`<div class="month-day other-month"><div class="month-day-number">${daysInPrev-i}</div></div>`;
    for(let d=1;d<=daysInMonth;d++){
        const dateStr=`${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const dayTasks=getTasksForDate(dateStr);
        html+=`<div class="month-day ${dateStr===today?'today':''}" onclick="openModal('${dateStr}')"
            ondragover="onDragOver(event,this)" ondragleave="onDragLeave(this)" ondrop="onDrop(event,'${dateStr}',this)">
            <div class="month-day-number" onclick="event.stopPropagation();jumpToDay('${dateStr}')"
                style="cursor:pointer;text-decoration:underline dotted;text-underline-offset:3px;display:inline-block;">${d}</div>
            ${dayTasks.map(t=>pillHtml(t,dateStr)).join('')}
        </div>`;
    }
    const total=Math.ceil((firstDay+daysInMonth)/7)*7;
    for(let d=1;d<=total-firstDay-daysInMonth;d++) html+=`<div class="month-day other-month"><div class="month-day-number">${d}</div></div>`;
    html+='</div>';
    document.getElementById('calendar-container').innerHTML=html;
}

// ===================== YEAR VIEW =====================
function renderYear(){
    const year=currentDate.getFullYear(), DN=t('DAY_NAMES'), MN=t('MONTH_NAMES');
    document.getElementById('nav-title').textContent=`${year}`;
    let html='<div class="year-grid">';
    for(let m=0;m<12;m++){
        const firstDay=new Date(year,m,1).getDay(), daysInMonth=new Date(year,m+1,0).getDate();
        html+=`<div class="year-month"><div class="year-month-title">${MN[m]}</div><div class="year-month-grid">`;
        DN.forEach(d=>{html+=`<div class="year-day-name">${d[0]}</div>`;});
        for(let i=0;i<firstDay;i++) html+=`<div class="year-day"></div>`;
        for(let d=1;d<=daysInMonth;d++){
            const dateStr=`${year}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const dayTasks=getTasksForDate(dateStr);
            const dots=dayTasks.length?'<div class="dots-row">'+dayTasks.map(t=>`<span class="dot ${getTaskClass(t,dateStr)}"></span>`).join('')+'</div>':'';
            html+=`<div class="year-day ${dateStr===today?'today':''}" onclick="jumpToDay('${dateStr}')">${d}${dots}</div>`;
        }
        html+='</div></div>';
    }
    html+='</div>';
    document.getElementById('calendar-container').innerHTML=html;
}

// ===================== Pills =====================
function pillHtml(task,dateStr){
    const cls=getTaskClass(task,dateStr);
    const rc=task.recurrence&&task.recurrence!=='none'?' recurring':'';
    const tl=task.due_time?`<span class="task-time">${displayTimeRange(task.due_time,task.due_time_end)}</span>`:'';
    return `<span class="task-pill ${cls}${rc}" draggable="true" ondragstart="onDragStart(event,${task.id})"
        title="${task.task}${task.due_time?' @ '+displayTimeRange(task.due_time,task.due_time_end):''}"
        onclick="event.stopPropagation()">${tl}${task.task}</span>`;
}

// ===================== Print =====================
function triggerPrint(){
    if(currentView==='day') buildPrintDay(formatDate(currentDate));
    else if(currentView==='year') buildPrintYear(currentDate.getFullYear());
    else buildPrintMonth(currentDate.getFullYear(),currentDate.getMonth());
    window.print();
}

function buildPrintDay(dateStr){
    const [y,m,d]=dateStr.split('-').map(Number);
    const dayTasks=getTasksForDate(dateStr);
    const alldayTasks=dayTasks.filter(t=>!t.due_time);
    const timedTasks=dayTasks.filter(t=>t.due_time);
    const printDate=new Date().toLocaleDateString(currentLang==='zh'?'zh-CN':'en-US',{month:'long',day:'numeric',year:'numeric'});
    const titleDate=currentLang==='zh'?`${y}Âπ¥${m}Êúà${d}Êó•`:new Date(y,m-1,d).toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
    const byHour={};
    timedTasks.forEach(task=>{ const h=parseInt(task.due_time.split(':')[0]); if(!byHour[h]) byHour[h]=[]; byHour[h].push(task); });
    let html=`<div class="print-header"><div><div class="print-title">üìÖ ${calendarName}</div><div class="print-subtitle">${titleDate}</div></div><div class="print-subtitle">${t('printed')} ${printDate}</div></div>`;
    if(alldayTasks.length){
        html+=`<div style="margin-bottom:10px;"><div style="font-size:10px;font-weight:700;color:#6b7280;text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px;">${t('all_day')}</div>${alldayTasks.map(t=>`<span class="print-task ${getTaskClass(t,dateStr)}" style="display:inline-block;margin:2px;">${t.task}</span>`).join('')}</div>`;
    }
    html+=`<table class="print-day-sched">`;
    for(let h=0;h<24;h++){
        const tasks=byHour[h]||[];
        if(!tasks.length&&(h<7||h>21)) continue;
        html+=`<tr><td class="sched-time">${h===0?'12 AM':h<12?h+' AM':h===12?'12 PM':(h-12)+' PM'}</td><td class="sched-tasks">${tasks.map(t=>`<span class="print-task ${getTaskClass(t,dateStr)}">${displayTimeRange(t.due_time,t.due_time_end)} ${t.task}${t.recurrence!=='none'?' üîÅ':''}</span>`).join('')}</td></tr>`;
    }
    html+=`</table><div class="print-legend"><div class="legend-item"><div class="legend-dot overdue"></div> ${t('overdue')}</div><div class="legend-item"><div class="legend-dot warning"></div> ${t('due_soon')}</div><div class="legend-item"><div class="legend-dot ontrack"></div> ${t('on_track')}</div><div class="legend-item"><div class="legend-dot done"></div> ${t('done')}</div></div>`;
    document.getElementById('print-view').innerHTML=html;
}

function buildPrintMonth(year,month){
    const MN=t('MONTH_NAMES'), DN=t('DAY_NAMES');
    const firstDay=new Date(year,month,1).getDay(), daysInMonth=new Date(year,month+1,0).getDate(), daysInPrev=new Date(year,month,0).getDate();
    const printDate=new Date().toLocaleDateString(currentLang==='zh'?'zh-CN':'en-US',{month:'long',day:'numeric',year:'numeric'});
    let html=`<div class="print-header"><div><div class="print-title">üìÖ ${calendarName}</div><div class="print-subtitle">${MN[month]} ${year}</div></div><div class="print-subtitle">${t('printed')} ${printDate}</div></div><div class="print-month-grid">`;
    DN.forEach(d=>{html+=`<div class="print-day-name">${d}</div>`;});
    for(let i=firstDay-1;i>=0;i--) html+=`<div class="print-day other-month"><div class="print-day-number">${daysInPrev-i}</div></div>`;
    for(let d=1;d<=daysInMonth;d++){
        const dateStr=`${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const dayTasks=getTasksForDate(dateStr);
        html+=`<div class="print-day ${dateStr===today?'today-print':''}"><div class="print-day-number">${d}</div>${dayTasks.map(t=>`<span class="print-task ${getTaskClass(t,dateStr)}">${t.due_time?displayTimeRange(t.due_time,t.due_time_end)+' ':''}${t.task}${t.recurrence!=='none'?' üîÅ':''}</span>`).join('')}</div>`;
    }
    const total=Math.ceil((firstDay+daysInMonth)/7)*7;
    for(let d=1;d<=total-firstDay-daysInMonth;d++) html+=`<div class="print-day other-month"><div class="print-day-number">${d}</div></div>`;
    html+=`</div><div class="print-legend"><div class="legend-item"><div class="legend-dot overdue"></div> ${t('overdue')}</div><div class="legend-item"><div class="legend-dot warning"></div> ${t('due_soon')}</div><div class="legend-item"><div class="legend-dot ontrack"></div> ${t('on_track')}</div><div class="legend-item"><div class="legend-dot done"></div> ${t('done')}</div><div class="legend-item">${t('recurring_legend')}</div></div>`;
    document.getElementById('print-view').innerHTML=html;
}

function buildPrintYear(year){
    const MN=t('MONTH_NAMES'), DN=t('DAY_NAMES');
    const printDate=new Date().toLocaleDateString(currentLang==='zh'?'zh-CN':'en-US',{month:'long',day:'numeric',year:'numeric'});
    let html=`<div class="print-header"><div><div class="print-title">üìÖ ${calendarName}</div><div class="print-subtitle">${year}</div></div><div class="print-subtitle">${t('printed')} ${printDate}</div></div><div class="print-year-grid">`;
    for(let m=0;m<12;m++){
        const firstDay=new Date(year,m,1).getDay(), daysInMonth=new Date(year,m+1,0).getDate();
        html+=`<div class="print-year-month"><div class="print-year-month-title">${MN[m]}</div><div class="print-year-mini-grid">`;
        DN.forEach(d=>{html+=`<div class="print-year-day-name">${d[0]}</div>`;});
        for(let i=0;i<firstDay;i++) html+=`<div class="print-year-day"></div>`;
        for(let d=1;d<=daysInMonth;d++){
            const dateStr=`${year}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const dayTasks=getTasksForDate(dateStr);
            const dots=dayTasks.length?'<div class="print-year-dots">'+dayTasks.map(t=>`<span class="print-year-dot ${getTaskClass(t,dateStr)}"></span>`).join('')+'</div>':'';
            html+=`<div class="print-year-day ${dateStr===today?'today-print':''} ${dayTasks.length?'has-tasks':''}">${d}${dots}</div>`;
        }
        html+='</div></div>';
    }
    html+=`</div><div class="print-legend"><div class="legend-item"><div class="legend-dot overdue"></div> ${t('overdue')}</div><div class="legend-item"><div class="legend-dot warning"></div> ${t('due_soon')}</div><div class="legend-item"><div class="legend-dot ontrack"></div> ${t('on_track')}</div><div class="legend-item"><div class="legend-dot done"></div> ${t('done')}</div></div>`;
    document.getElementById('print-view').innerHTML=html;
}

// ===================== Modal =====================
function openModal(dateStr){ openModalWithTime(dateStr,'',''); }
function openModalWithTime(dateStr,startTime,endTime){
    selectedDate=dateStr;
    document.getElementById('modal-title').textContent='üìÖ '+friendlyDate(dateStr);
    document.getElementById('new-task-name').value='';
    document.getElementById('new-task-date').value=dateStr;
    document.getElementById('new-task-time').value=startTime||'';
    document.getElementById('new-task-time-end').value=endTime||'';
    updateRecurrenceOptions(dateStr,'new-task-recurrence');
    document.getElementById('modal-overlay').classList.add('open');
    renderModalTasks();
}
function closeModal(){ document.getElementById('modal-overlay').classList.remove('open'); }
function handleOverlayClick(e){ if(e.target===document.getElementById('modal-overlay')) closeModal(); }

function renderModalTasks(){
    const dayTasks=getTasksForDate(selectedDate);
    const body=document.getElementById('modal-body');
    if(!dayTasks.length){ body.innerHTML=`<div class="modal-empty">${t('no_tasks')}</div>`; return; }
    body.innerHTML=dayTasks.map(task=>{
        const cls=getTaskClass(task,selectedDate);
        const isDone=isCompletedOnDate(task,selectedDate);
        const isRec=task.recurrence&&task.recurrence!=='none';
        const timeDisplay=task.due_time?`<span class="modal-task-time">üïê ${displayTimeRange(task.due_time,task.due_time_end)}</span>`:'';
        return `<div class="modal-task ${cls}" id="modal-task-${task.id}">
            <div class="modal-task-row">
                <div class="modal-task-info">
                    <span class="modal-task-name ${isDone?'done-text':''}">${task.task}</span>
                    ${timeDisplay}
                    ${isRec?`<span class="modal-task-recur">${recurLabel(task.recurrence,task.due_date)}</span>`:''}
                </div>
                <div class="modal-task-actions">
                    <button class="btn-small btn-toggle ${isDone?'undo':''}" onclick="toggleTask(${task.id},'${selectedDate}')">${isDone?t('done'):'‚úî'}</button>
                    <button class="btn-small btn-edit" onclick="toggleEditForm(${task.id})">‚úèÔ∏è</button>
                    <button class="btn-small btn-delete" onclick="deleteTask(${task.id})">üóëÔ∏è</button>
                </div>
            </div>
            <div class="edit-form" id="edit-form-${task.id}">
                <input type="text" id="edit-name-${task.id}" value="${task.task}">
                <input type="date" id="edit-date-${task.id}" value="${task.due_date}" onchange="updateRecurrenceOptions(this.value,'edit-recur-${task.id}')">
                <div class="edit-time-row">
                    <span style="font-size:13px;">‚è∞</span>
                    <input type="time" id="edit-time-${task.id}" value="${task.due_time||''}" onchange="autoFillEndTime('edit-time-${task.id}','edit-time-end-${task.id}')">
                    <span class="edit-time-sep">‚Üí</span>
                    <input type="time" id="edit-time-end-${task.id}" value="${task.due_time_end||''}">
                </div>
                <select id="edit-recur-${task.id}"><option value="none">${t('no_repeat')}</option></select>
                <div class="edit-form-btns">
                    <button class="btn-small btn-save" onclick="saveEdit(${task.id})">${t('save')}</button>
                    <button class="btn-small btn-cancel" onclick="toggleEditForm(${task.id})">${t('cancel')}</button>
                </div>
            </div>
        </div>`;
    }).join('');
}

function toggleEditForm(taskId){
    const form=document.getElementById(`edit-form-${taskId}`);
    form.classList.toggle('open');
    if(form.classList.contains('open')){
        const dateVal=document.getElementById(`edit-date-${taskId}`).value;
        const task=allTasks.find(t=>t.id===taskId);
        updateRecurrenceOptions(dateVal,`edit-recur-${taskId}`);
        const sel=document.getElementById(`edit-recur-${taskId}`);
        if(task&&[...sel.options].some(o=>o.value===task.recurrence)) sel.value=task.recurrence;
    }
}

// ===================== Task CRUD =====================
async function addTask(){
    const name=document.getElementById('new-task-name').value.trim();
    const due_date=document.getElementById('new-task-date').value;
    const due_time=document.getElementById('new-task-time').value;
    const due_time_end=document.getElementById('new-task-time-end').value;
    const recurrence=document.getElementById('new-task-recurrence').value;
    if(!name) return;
    const res=await fetch('/api/task/add',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({task:name,due_date,due_time,due_time_end,calendar_id:calendarId,recurrence})});
    const nt=await res.json();
    allTasks.push({id:nt.id,task:nt.task,due_date:nt.due_date,due_time:nt.due_time||'',due_time_end:nt.due_time_end||'',done:false,recurrence:nt.recurrence||'none',completed_dates:[]});
    document.getElementById('new-task-name').value='';
    document.getElementById('new-task-time').value='';
    document.getElementById('new-task-time-end').value='';
    renderModalTasks(); render();
}

async function toggleTask(taskId,dateStr){
    const res=await fetch(`/api/task/toggle/${taskId}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({date:dateStr})});
    const data=await res.json();
    const task=allTasks.find(t=>t.id===taskId);
    if(task){
        const isRec=task.recurrence&&task.recurrence!=='none';
        if(isRec){ if(data.done===1){if(!task.completed_dates.includes(dateStr)) task.completed_dates.push(dateStr);}else{task.completed_dates=task.completed_dates.filter(d=>d!==dateStr);} }
        else { task.done=data.done===1; }
    }
    if(data.new_task) allTasks.push({id:data.new_task.id,task:data.new_task.task,due_date:data.new_task.due_date,due_time:data.new_task.due_time||'',due_time_end:data.new_task.due_time_end||'',done:false,recurrence:data.new_task.recurrence||'none',completed_dates:[]});
    renderModalTasks(); render();
}

async function saveEdit(taskId){
    const name=document.getElementById(`edit-name-${taskId}`).value.trim();
    const due_date=document.getElementById(`edit-date-${taskId}`).value;
    const due_time=document.getElementById(`edit-time-${taskId}`).value;
    const due_time_end=document.getElementById(`edit-time-end-${taskId}`).value;
    const recurrence=document.getElementById(`edit-recur-${taskId}`).value;
    if(!name) return;
    await fetch(`/api/task/edit/${taskId}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({task:name,due_date,due_time,due_time_end,recurrence})});
    const task=allTasks.find(t=>t.id===taskId);
    if(task){task.task=name;task.due_date=due_date;task.due_time=due_time;task.due_time_end=due_time_end;task.recurrence=recurrence;}
    if(due_date!==selectedDate) selectedDate=due_date;
    renderModalTasks(); render();
}

async function deleteTask(taskId){
    if(!confirm(t('delete_task'))) return;
    await fetch(`/api/task/delete/${taskId}`,{method:'POST'});
    allTasks=allTasks.filter(t=>t.id!==taskId);
    renderModalTasks(); render();
}

updateDarkBtn(); applyLang(); updateLangBtn(); render();
</script>
</body>
</html>